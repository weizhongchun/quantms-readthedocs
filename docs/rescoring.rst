quantms rescoring framework (AI-assisted rescoring of peptide identifications)
==============================================================================

quantms DDA workflows DDAplex (:doc:`iso`) and DDA-LFQ (:doc:`lfq`) use multiple search engines (:doc:`msgf`, :doc:`comet`, :doc:`sage`) to identify peptides from mass spectra. The output of these search engines is a list of peptide-spectrum matches (PSMs) along with their corresponding scores, which vary depending on the search engine. 

quantms uses :doc:`percolator`, an SVM-based classifier, to boost the number of identifications by using additional properties of the PSMs to better separate true positives from false positives. Among the properties Percolator uses are: retention time, number of missed cleavages, peptide length, and the original search engine scores. The majority of these properties are computed by Percolator or calculated by the OpenMS PercolatorAdapter. 

.. important:: From our experience with Percolator and running datasets with quantms at quantms.org, this is the most stable/production-ready way to boost the number of identifications. 

Recent developments in deep-learning algorithms have enabled the proteomics community to compute additional properties for PSMs that are now available for Percolator to enable more accurate rescoring. quantms has developed a component called `quantms-rescoring <https://github.com/bigbio/quantms-rescoring>`_ which enables the computation of additional properties/features for each PSM using these algorithms.

About quantms-rescoring
-----------------------

`quantms-rescoring package <https://github.com/bigbio/quantms-rescoring>`_ is a specialized Python tool and package that enhances peptide-spectrum match (PSM) confidence in proteomics data analysis by integrating multiple machine learning models and advanced feature engineering techniques. The tool serves as a crucial component in the quantms ecosystem, functioning as an "intelligent" **feature** annotation pipeline that processes idXML files from OpenMS workflows and their corresponding mzML spectral data. At its core, quantms-rescoring combines predictions from state-of-the-art models, including MS2PIP [DEG2016]_ / AlphaPeptDeep [ZENG2022]_ for fragment intensity prediction, DeepLC [BOUW2021]_ for retention time prediction, while also computing novel spectrum quality metrics such as signal-to-noise ratios, spectral entropy, total ion current distribution, and weighted m/z standard deviation. 

The core functionality of quantms-rescoring lies in its intelligent model selection capabilities - it automatically evaluates and selects optimal MS2PIP models based on fragmentation type and correlation quality, dynamically adjusts MS2 tolerance parameters, and employs sophisticated validation mechanisms to ensure model appropriateness for each dataset. Additionally, it implements automatic benchmarking between pretrained and retrained DeepLC models, selecting the configuration with the lowest Mean Absolute Error for retention time prediction while performing per-run calibration to account for chromatographic variations. 

The comprehensive feature set generated by quantms-rescoring significantly improves the discriminative power of Percolator by providing rich, validated annotations that capture both spectral prediction accuracy and experimental data quality, ultimately leading to enhanced peptide identification confidence and reduced false discovery rates in large-scale proteomics experiments.

How quantms-rescoring works in a nutshell
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The quantms-rescoring framework employs a sophisticated multi-tier methodology for feature generation, model selection, and optimization that goes far beyond traditional rescoring approaches. **Feature generators are selected** through a configurable pipeline system where users can specify combinations of "ms2pip", "deeplc", "alphapeptdeep", and spectrum quality modules, with each generator contributing complementary information about spectral prediction accuracy, retention time behavior, and data quality. 

- **Model selection operates through an intelligent competition-based system**: for MS2PIP, the tool automatically evaluates the user-specified model against a comprehensive library of fragmentation-specific models (HCD, CID variants) by computing Pearson correlations between predicted and observed spectra on a calibration set (typically 20% of high-scoring target PSMs), selecting the model that achieves the highest correlation above a 0.4 threshold while ensuring at least 70% of the calibration set exceeds a 0.6 correlation threshold. The system further implements **automatic tolerance optimization** by analyzing both user-provided and dataset-inferred tolerances, dynamically adjusting parameters when initial settings prove suboptimal for the data characteristics. 

- **For DeepLC optimization**, the tool employs a sophisticated benchmarking approach that creates separate instances using pretrained and retrained models, evaluates their performance on a 60% calibration subset by computing Mean Absolute Error (MAE) for retention time predictions, and selects the superior performer while maintaining per-run calibration to account for chromatographic drift. **The optimization process extends to feature validation** through correlation-based quality control mechanisms that ensure only high-performing models contribute to the final feature set, with configurable thresholds for correlation quality (default 70% of calibration PSMs above 0.6 correlation) and calibration set composition (default 20% of top-scoring targets). This multi-layered approach ensures that quantms-rescoring adapts automatically to diverse experimental conditions, fragmentation methods, and instrument configurations while maintaining rigorous quality standards for feature generation, ultimately providing optimized, validated features that maximize the discriminative power of downstream rescoring algorithms.


.. image:: images/quantms-rescoring.png
   :width: 800
   :align: center

Core Components
~~~~~~~~~~~~~~~

MS2PIP Integration

- **Intelligent Model Selection**: Automatically evaluates and selects the optimal MS2PIP model for each dataset based on fragmentation type and correlation quality
- **Supported Models**: HCD2019, HCD2021, Immuno-HCD, HCDch2, TMT, iTRAQ, iTRAQphospho, CID, CIDch2, CID-TMT
- **Adaptive MS2 Tolerance**: Dynamically adjusts MS2 tolerance based on dataset characteristics
- **Correlation Validation**: Implements robust validation ensuring sufficient correlation with experimental spectra

MS2PIP Features (70+ features)

.. list-table:: MS2PIP Feature Examples
   :header-rows: 1
   :widths: 30 70

   * - Feature Category
     - Examples
   * - Spectral Correlations
     - SpecPearson, SpecCosineNorm, DotProd
   * - Ion-specific Metrics
     - IonBPearsonNorm, IonYPearsonNorm
   * - Statistical Measures
     - SpecMseNorm, MinAbsDiffNorm, MeanAbsDiffNorm

AlphaPeptDeep Integration

- **Generic Deep Learning Model**: Leverages advanced neural networks for fragment intensity prediction
- **Transfer Learning**: Competes with MS2PIP to select the best-performing model
- **Feature-Rich Output**: Generates comprehensive spectral similarity features

DeepLC Optimization

- **Model Benchmarking**: Automatically compares pretrained vs. retrained models
- **Per-Run Calibration**: Calibrates models for each run to account for chromatographic variations
- **MAE-Based Selection**: Selects model with lowest Mean Absolute Error for retention time prediction
- **Best Peptide Tracking**: Maintains best retention time prediction for each peptide across multiple PSMs

DeepLC Features (6 features)

.. list-table:: DeepLC Features
   :header-rows: 1
   :widths: 35 65

   * - Feature
     - Description
   * - ObservedRetentionTime
     - Experimental retention time
   * - PredictedRetentionTime
     - Model-predicted retention time
   * - RtDiff
     - Difference between observed and predicted
   * - Best variants
     - Best predictions across multiple PSMs

Spectrum-Based Features

Signal Quality Metrics

- **Signal-to-Noise Ratio (SNR)**: Calculates ratio of maximum intensity to background noise
- **Spectral Entropy**: Quantifies uniformity of peak distribution
- **TIC Distribution Analysis**: Analyzes distribution of Total Ion Current across peaks
- **Weighted m/z Standard Deviation**: Estimates spectral complexity through intensity-weighted calculations

Spectrum Quality Features (4 features)

.. list-table:: Spectrum Quality Features
   :header-rows: 1
   :widths: 30 70

   * - Feature
     - Description
   * - Snr
     - Signal-to-noise ratio
   * - SpectralEntropy
     - Peak distribution uniformity
   * - FracTICinTop10Peaks
     - Fraction of total ion current in top peaks
   * - WeightedStdMz
     - Intensity-weighted m/z standard deviation

SAGE Integration
- **Seamless Feature Import**: Incorporates additional features from SAGE (Spectrum Agnostic Generation of Embeddings)
- **Feature Validation**: Ensures proper formatting for OpenMS compatibility
- **Flexible Integration**: Supports external feature tables and annotations

The package implements multiprocessing capabilities for efficient handling of large datasets and maintains compatibility with OpenMS formats (idXML and mzML). It supports various fragmentation methods and MS analyzers through multiple pre-trained models.

.. note:: The quantms-rescoring package currently supports only MS2 level spectra and requires that input files contain consistent MS levels and dissociation methods.

Feature Generators in quantms-rescoring
---------------------------------------


quantms-rescoring uses multiple open-source components to compute additional features for each PSM based on deep-learning algorithms:

- **DeepLC**: Predicts peptide retention times using deep learning, including modified peptides 
- **MS2PIP**: Predicts MS/MS peak intensities for peptide fragmentation 
- **AlphaPeptDeep**: Predicts peptide fragmentation intensity and retention time
- **Spectrum features**: Computes signal-to-noise ratio, spectral entropy, and other spectrum-derived metrics

Using the parameter ``--feature_generators``, you can specify which feature generators to use. Possible values are ``deeplc``, ``ms2pip``, ``alphapeptdeep``. For ms2pip and alphapeptdeep, the model is specified using the ``--ms2_model`` parameter. To see the supported models, see the :ref:`supported-ms2pip-models-table` section. If the feature generator is alphapeptdeep, the ``--ms2_model`` MUST be ``generic``. For deeplc, the model is selected automatically. 

.. note:: quantms-rescoring uses the model specified by the generator to compute features. The ms2pip and alphapeptdeep models are mutually exclusive; they cannot be used together.

Configuration Parameters
------------------------

quantms provides comprehensive control over the rescoring process through the following parameters:

**Core Rescoring Settings**

- ``--ms2rescore`` (default: ``false``): Enable/disable peptide identification rescoring with LC-MS predictors such as MS²PIP and DeepLC
- ``--rescore_range`` (default: ``independent_run``): Defines the scope of rescoring:
  - ``independent_run``: Rescoring performed independently for each run
  - ``by_sample``: Rescoring performed at the sample level
  - ``by_project``: Rescoring performed across the entire project

**Model Configuration**

- ``--ms2_model`` (default: ``HCD2021``): Specifies which deep learning model to use for feature generation
- ``--ms2_model_dir`` (default: ``null``): Path to local MS2 prediction model files to avoid repeated downloads
- ``--find_best_model`` (default: ``true``): Automatically find the best MS2 model for the dataset
- ``--force_model`` (default: ``false``): Force usage of the specified MS2PIP model without optimization

.. _supported-ms2pip-models:

Supported MS2PIP Models

- ``--feature_generators`` (default: ``deeplc,ms2pip``): Specifies which feature generators to use
- ``--add_snr_feature_percolator`` (default: ``false``): Add signal-to-noise ratio features for identification rescoring
- ``--consider_modloss`` (default: ``false``): Include modification loss ions in MS2 model predictions (useful for phospho-peptide analysis)

**Technical Parameters**

- ``--calibration_set_size`` (default: ``0.15``): Percentage of data used as calibration set for DeepLC (15%)
- ``--ms2rescore_fragment_tolerance`` (default: ``0.05``): Fragment mass tolerance used for MS2PIP (in Da)

.. important:: For optimal results, ensure that your experimental data matches the properties of the selected MS2PIP model in terms of fragmentation method, mass analyzer, and peptide modifications. We recommend to use the parameter ``--find_best_model true`` and ``--force_model false`` which will automatically select the best model for your dataset. 

.. _supported-ms2pip-models-table:

Supported MS2PIP Models
-----------------------

quantms supports multiple pre-trained MS2PIP models optimized for different experimental conditions. For different experiments, the model can be specified using the ``--ms2_model`` parameter, and the ``--ms2_model_dir`` parameter can point to a local directory to avoid duplicate model downloads:

+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| Model        | Fragmentation method | MS2 mass analyzer                      | Peptide properties                                 |
+==============+======================+========================================+====================================================+
| HCD2019      | HCD                  | Orbitrap                               | Tryptic digest                                     |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| HCD2021      | HCD                  | Orbitrap                               | Tryptic / Chymotrypsin digest                      |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| CID          | CID                  | Linear ion trap                        | Tryptic digest                                     |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| iTRAQ        | HCD                  | Orbitrap                               | Tryptic digest, iTRAQ-labeled                      |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| iTRAQphospho | HCD                  | Orbitrap                               | Tryptic digest, iTRAQ-labeled, enriched for        |
|              |                      |                                        | phosphorylation                                    |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| TMT          | HCD                  | Orbitrap                               | Tryptic digest, TMT-labeled                        |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| TTOF5600     | CID                  | Quadrupole time-of-flight              | Tryptic digest                                     |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| HCDch2       | HCD                  | Orbitrap                               | Tryptic digest                                     |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| CIDch2       | CID                  | Linear ion trap                        | Tryptic digest                                     |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| Immuno-HCD   | HCD                  | Orbitrap                               | Immunopeptides                                     |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| CID-TMT      | CID                  | Linear ion trap                        | Tryptic digest, TMT-labeled                        |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| timsTOF2023  | CID                  | Ion mobility quadrupole time-of-flight | Tryptic-, elastase digest, immuno class 1          |
+--------------+----------------------+----------------------------------------+----------------------------------------------------+
| timsTOF2024  | CID                  | Ion mobility quadrupole time-of-flight | Tryptic-, elastase digest, immuno class 1 & class 2|
+--------------+----------------------+----------------------------------------+----------------------------------------------------+

.. note:: The complete feature mapping between quantms-rescoring feature names is available in the `quantms-rescoring documentation <https://github.com/bigbio/quantms-rescoring>`_.

Usage Examples
--------------

**Basic rescoring with default settings:**

.. code-block:: bash

   nextflow run nf-core/quantms --ms2rescore true --input samplesheet.csv --fasta database.fasta

**Advanced rescoring with custom model:**

.. code-block:: bash

   nextflow run nf-core/quantms \
     --ms2rescore true \
     --ms2_model TMT \
     --add_snr_feature_percolator true \
     --input samplesheet.csv \
     --fasta database.fasta

**Rescoring with local model directory:**

.. code-block:: bash

   nextflow run nf-core/quantms \
     --ms2rescore true \
     --ms2_model_dir /path/to/models \
     --force_model true \
     --input samplesheet.csv \
     --fasta database.fasta

Troubleshooting
---------------

**Feature generator failures**: These might result from incorrect model parameters or unsupported experimental types leading to poor model predictions. In such cases, MS2Rescore can be disabled using ``--ms2rescore false`` (default setting).

**Memory and performance**: For large datasets, consider:

- Using ``--rescore_range independent_run`` for better memory management
- Setting ``--ms2_model_dir`` to a local directory to avoid repeated downloads

**Missing spectra**: The package filters out PSMs with missing spectral information or empty peaks. Ensure your input mzML files contain the expected MS2 spectra.

For additional details on the main algorithm [DEG2016]_, [BOUW2021]_, please refer to the publications.

References
----------

.. [DEG2016] Sven Degroeve, Lennart Martens. MS2PIP: a tool for MS/MS peak intensity prediction. Bioinformatics, 3199–3203,
   September 2013

.. [BOUW2021] Robbin Bouwmeester, Ralf Gabriels, Niels Hulstaert, Lennart Martens, Sven Degroeve. DeepLC can predict retention times for peptides that carry as-yet unseen modifications. Nature Methods, 1363–1369, October 2021

.. [ZENG2022] Zeng, Wen-Feng, et al. AlphaPeptDeep: a modular deep learning framework to predict peptide properties for proteomics. Nature Communications 13.1 (2022): 7238.
